name: Inox CI
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
jobs:
  tests:
    if: github.event.pull_request.draft == false
    name: ${{ matrix.runners.name }} / JDK ${{ matrix.java-version }}
    runs-on: ${{ matrix.runners.labels }}
    strategy:
      matrix:
        runners:
          - name: Linux
            os: Linux
            labels: ['self-hosted', 'linux']
          - name: macOS ARM64
            os: macOS
            labels: ['macos-latest']
        java-version: [17, 21]
    env:
      # solver versions to test against
      INSTALL_SOLVERS: 1
      Z3_VER: 4.15.1
      CVC4_VER: 1.8
      CVC5_VER: 1.2.1
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: ${{ matrix.java-version }}
    - name: Set Java and SBT options
      run: |
        # path for sbt to create a local folder and sockets
        # needs to be a bit shallower than the workspace
        # to avoid unix socket path length limits
        echo "XDG_RUNTIME_DIR=$(realpath ..)" >> $GITHUB_ENV
        # java options for sbt and sbt-extras
        JAVA_OPTS_TMP_DIR=./tmp_java
        JAVA_OPTS="-Xss64M -Xms1024M -Xmx8G -Djava.io.tmpdir=$JAVA_OPTS_TMP_DIR"
        JVM_OPTS="$JAVA_OPTS"
        echo "JAVA_OPTS_TMP_DIR=$JAVA_OPTS_TMP_DIR" >> $GITHUB_ENV
        echo "JAVA_OPTS=$JAVA_OPTS" >> $GITHUB_ENV
        echo "JVM_OPTS=$JVM_OPTS" >> $GITHUB_ENV 
    - name: Install and set up sbt
      run: |
        ./scripts/install_sbt.sh
        echo "$(pwd)/sbt/bin/" >> $GITHUB_PATH
    - name: Set sbt global base
      # scala-smtlib is fetched via sbt's RootProject(uri(...)), which clones
      # and compiles it into the sbt global staging directory. On self-hosted
      # runners this directory is shared across runners and persists across
      # runs, causing stale .tasty/.class files and race conditions between
      # concurrent jobs. Isolating sbt's global base per workspace avoids
      # this. Can be reverted if scala-smtlib is published to Maven.
      run: echo "SBT_OPTS=-Dsbt.global.base=$GITHUB_WORKSPACE/.sbt-global" >> $GITHUB_ENV
    - name: Prepare temp folder
      run: rm -rf $JAVA_OPTS_TMP_DIR && mkdir -p $JAVA_OPTS_TMP_DIR
    - name: Install solvers
      run: ./scripts/install_solvers.sh $GITHUB_WORKSPACE/.local/bin $Z3_VER $CVC4_VER $CVC5_VER
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Add solvers to PATH
      run: echo "$GITHUB_WORKSPACE/.local/bin" >> $GITHUB_PATH
    - name: Test solver availability
      run: cvc5 --version && z3 --version && cvc4 --version
    - name: Run Tests
      run: sbt -Dtest-parallelism=10 -batch test
    - name: Run integration tests
      run: sbt -Dtest-parallelism=10 -batch it:test
    - name: Clean up
      run: rm -rf $JAVA_OPTS_TMP_DIR
